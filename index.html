<!DOCTYPE html>
<meta charset="utf-8">
<link href='http://fonts.googleapis.com/css?family=Fenix' rel='stylesheet' type='text/css'>
<!-- <link rel="stylesheet" href="tooltip.css"> -->
<style>
body {
  font-family: Fenix, serif;
  font-size: 11;
  /*width: 620px;*/
}
.background {
  fill: none;
  pointer-events: all;
}
#states {
  fill: #333;
  fill-opacity: 0.6;
}
#states .active {
  fill: orange;
}
#state-borders {
  fill: none;
  stroke: #fff;
  stroke-width: 1.5px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}
.legendTitle {
  font-weight: bold;
}
span {
  /*color: pink;*/
  font-weight: bold;
  text-transform: uppercase;
}
.state {
  stroke: none;
  stroke-width: 3px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: steelblue;
  opacity: 0.8;
/*  stroke: white;
  stroke-dasharray: 5,5;
  stroke-width: 3px;*/
}

.title{
  font-size: 18px;
  fill: white;
  /*dx: 2em;*/
}

</style>
<!-- <link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css"> -->
<script src="http://d3js.org/d3.v3.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/colorbrewer.v1.min.js"></script>
<script src="libraries/angular.min.js"></script>

<!-- <script src="d3-tip.js"></script> -->


<body ng-app="mainApp" ng-controller="mainCtrl">

  <div class=".d3-tip">
  </div>
  <div style="width: 620px;">
    <h2 style="text-align:center;">Abortion Statistics</h2>
    <div map-vis></div>
    <h3 style="text-align:center;">Abortions per 1,000 Women Ages 15-44</h3>
    <div line-chart></div>
    <p style="float: right;">Source: <a target="_blank" href="http://www.sentencingproject.org/doc/publications/fd_State_Level_Estimates_of_Felon_Disen_2010.pdf">The Sentencing Project</a></p>
  </div>
    
</body>

<script src="map.js"></script>
<script src="rates.js"></script>

<script>

var app = angular.module('mainApp', [])

app.controller('mainCtrl', ['$scope', function(scope){

  var restrictionById = d3.map();

  var color = d3.scale.ordinal().domain([1, 2, 3, 4, 5]).range(['rgb(254,229,217)', 'rgb(252,174,145)', 'rgb(251,106,74)', 'rgb(222,45,38)', 'rgb(165,15,21)'])

  restrictions.forEach(function(d) {
    restrictionById.set(d.id, color(+d.restriction));
  });

  us.objects.states.geometries.forEach(function(d) {
    d.properties = restrictions.filter(function(v) {
      return +v.id == +d.id;
    })[0];
  });

  scope.us = us;

  var lineData = {};

  var parseDate = d3.time.format("%Y").parse;

  d3.keys(rates[0])
    .filter(function(name) {
      return name !== "date"
    })
    .forEach(function(key) {
      lineData[key] = rates.map(function(d) {
        return {
          date: parseDate(new String(d.date)),
          val: d[key]
        }
      });
    });

  scope.lineData = lineData;  

  scope.state="Alabama";
  
}]);

app.directive('mapVis', function(){
  // Runs during compile
  return {
    restrict: 'A', // E = Element, A = Attribute, C = Class, M = Comment
    link: function(scope, el, attr) {
      var width = 550,
        height = 330,
        centered;

      var projection = d3.geo.albersUsa()
        .scale(750)
        .translate([width / 2, height / 2 ]);

      var GeoPath = d3.geo.path()
        .projection(projection);

      var margin = {
        top: 20,
        left: 50,
        right: 10,
        bottom: 10
      };

      var svg = d3.select(el[0]).append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)

      // svg.append("rect")
      //   .attr("class", "background")
      //   .attr("width", width + margin.left + margin.right)
      //   .attr("height", height + margin.top + margin.bottom)

      var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var stateG = g.append("g")
        .attr("id", "states")
        .selectAll("path")
        .data(topojson.feature(scope.us, scope.us.objects.states).features)
        .enter().append("path")
        .attr("class", "state-area")
        .attr("d", GeoPath)
        .attr("stroke", "black")
        .attr("stroke-width", "2px")
        .attr("stroke-opacity", 0.2);

      stateG.on("mouseover", function(d){
        scope.$apply(function(){

          // console.log(d.name)

          scope.state = d.properties.name;

        })
      });


      g.append("path")
        .datum(topojson.mesh(scope.us, scope.us.objects.states, function(a, b) {
          return a !== b;
        }))
        .attr("id", "state-borders")
        .attr("d", GeoPath);
    }
  };
});


app.directive('lineChart', 
  function() {

    // Runs during compile
    return {
      restrict: 'A', // E = Element, A = Attribute, C = Class, M = Comment
      link: function(scope, el, attrs) {
        var width = 550,
          height = 200;

        var margin = {
          top: 10,
          left: 50,
          right: 10,
          bottom: 25
        };

        var x = d3.time.scale()
          .range([0, width]);

        var y = d3.scale.linear()
          .range([height, 0]);

        var xAxis = d3.svg.axis()
          .scale(x)
          .orient("bottom");

        var yAxis = d3.svg.axis()
          .scale(y)
          // .tickFormat(d3.format("%"))
          .orient("left");

        var line = d3.svg.area()
          .x(function(d) {
            return x(d.date);
          })
          .y0(height)
          .y1(function(d) {
            return y(d.val);
          });

        var svg = d3.select(el[0])
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

        var xAxisG = svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")

        var yAxisG = svg.append("g")
          .attr("class", "y axis")

        var path = svg.append("path")


        var titleG = svg.append("g")
          .attr("transform","translate(" + [width-50,10] + ")")

        var titleRect = titleG.append("rect")
          .attr({
            width: 0,
            height: 25,
            fill: "#222",
            opacity: .8,
            stroke: "none"
          })
          // .attr("fill","black")
          // .attr("fill-opacity",0.5)

        var title = titleG.append("text")
          .attr("class","title")
          .attr("dx","-.5em")
          .attr("text-anchor","end")
          // .datum(localData)
          // .attr("class", "line")
          // .attr("d", line);

          // yAxisG.append("text")
          //   .attr("transform", "rotate(-90)")
          //   .attr("y", 6)
          //   .attr("dy", ".71em")
          //   .style("text-anchor", "end")
          //   .text("Abortions per 1,000 Women ($)");

          var oldU = 100;

        scope.$watch("state", function(newVal) {

          if(newVal==null) return;

          title.transition().duration(150)
            .style("fill-opacity", 0)
            .attr("dy",".5em")

          title.transition().delay(150)
            .duration(0)
            .attr("dy","1.5em")
            .text(newVal)
            .each('end',function(){

              var delA = 0,
              delB = 300;

              if(u < oldU) {
                delA = 300;
                delB = 0;
              }

              var u = d3.select(this).node().getComputedTextLength()+18;

              titleRect.transition().delay(delA).duration(300)
                .ease("elastic")
                .attr("width",u)
                .attr("x",-u)

              d3.select(this).transition().duration(300).delay(delB)
              .ease("elastic")
              .style("fill-opacity",1)
              .attr("dy","1em")

              oldU = u

              var localData = scope.lineData[newVal];

              x.domain(d3.extent(localData, function(d) {
                return d.date;
              }));

              // y.domain([0, d3.max(localData, function(d) {
              //   return d.val;
              // })]);

            y.domain(d3.extent(localData, function(d) {
              return d.val;
            }));

              yAxisG.transition().duration(250).call(yAxis);

              xAxisG.transition().duration(250).call(xAxis);

              path.datum(localData)
                .transition().duration(350)
                .attr("class", "line")
                .attr("d", line);
            })


        });

      }
    };
  }
);
</script>
